select vv.id, vv.price, vv.is_rebill, date(vv.date) as date, vv.pages, vv.slides, vv.is_complex_subject,
 vv.problems, vv.Type_of_paper, vv.AL, vv.Deadline, vv.Spacing, vv.site, vv.Pro, vv.Top, vv.Progressive_delivery,  
 vv.Plagiarism_report, vv.Soft_copies, vv.Draft, vv.Summary,   
 ifnull((select round(pp.price,2) from prices pp where pp.paper_type_group = vv.paper_type_group and
 pp.academic_level = vv.academic_level and pp.deadline = vv.deadline_tech and pp.type_of_work = vv.type_of_work 
 and pp.client_app_id = vv.site_tech), ifnull((select round(min(pp.price),2) from prices pp
 where pp.academic_level = vv.academic_level and pp.deadline = vv.deadline_tech
 and pp.type_of_work = vv.type_of_work and pp.client_app_id = vv.site_tech),  ifnull((select round(pp.price,2) 
 from prices pp where pp.paper_type_group = vv.paper_type_group and pp.academic_level = vv.academic_level 
 and pp.deadline = vv.deadline_tech and pp.type_of_work = vv.type_of_work and pp.client_app_id = 5),
 (select round(pp.price,2) from prices pp where pp.academic_level = vv.academic_level 
 and pp.deadline = vv.deadline_tech and pp.type_of_work = vv.type_of_work and pp.client_app_id = 5 limit 1))))
 as price_per_page,
 vv.channel, vv.sp_essays
 from
 (( select o.id as id, o.price as price, o.is_rebill as is_rebill, o.created_at as date, x.value as AL, 
 o.pages as pages, o.slides as slides, o.problems as problems,  y.value as Type_of_paper, 
 if((z.value like 'Accounting' or z.value like 'Art & architecture' or z.value like 'Building and Planning'
 or z.value like 'Chemistry' or z.value like 'Computer science' or z.value like 'Finance' or z.value 
 like 'Mathematics' or z.value like 'Physics' or z.value like 'Statistics' or z.value like 'IT' 
 or z.value like 'Web' or z.value like 'Biology' or z.value like 'Engineering' or z.value like 'Investments'),1,0)
 as is_complex_subject,  j.value as Spacing, o.user_id, (select oa.name from oauth_clients oa where
 oa.id = u.app_id) as site, coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id 
 and ou.upsale_id = 2 limit 1),0) as Pro, coalesce((select ou.upsale_id from order_upsale ou where
 ou.order_id = o.id and ou.upsale_id = 3 limit 1),0) as Top, 
 coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and ou.upsale_id = 5 limit 1),0) 
 as Progressive_delivery, coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and
 ou.upsale_id = 4 limit 1),0) as Plagiarism_report, 
 coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and ou.upsale_id = 8 limit 1),0) 
 as Soft_copies, 
 coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and ou.upsale_id = 10 limit 1),0) 
 as Draft,
 coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and ou.upsale_id = 9 limit 1),0)
 as Summary, coalesce(o.software_id, 0) as Software,
 coalesce((select ou.upsale_id from order_upsale ou where ou.order_id = o.id and ou.upsale_id = 4 limit 1),0)
 as 'Plagiarism report',
 ss.value as Deadline, paper_type_group.ovd as paper_type_group,
 academic_level.ovd as academic_level, deadline.ovd as deadline_tech, type_of_work.ovd as type_of_work,
 site.sit as site_tech,
 if(u.referrer_id in (38557, 141078 ,139112, 89177, 139112, 159382, 159383, 159384, 161322, 161323, 161324 ), 'reviews',   
 if(u.referrer_id in (15474, 141228), 'ppc',   if(u.referrer_id = 49692, 'seo',   if(u.referrer_id in (49871,242), 'smm',   
 if(u.referrer_id in (141405, 146402, 146757,146091,149486), 'other',   if(u.referrer_id in (0, 52130), 'organic', 
if(r.referrer_type_id = 4, 'refferal', 'webmasters'))))))) as channel,  if(u.link_id = 79431, 1, 0) as sp_essays
 
 from orders o  inner join users u on u.id = o.user_id left join referrers r on r.id = u.referrer_id
 inner join optionables op on op.optionable_id = o.id 
 inner join (select op.optionable_id as id, ov.value as value from optionables op 
 inner join option_values ov on ov.id = op.option_value_id where op.option_id = 2) as x on x.id = o.id
 inner join (select op.optionable_id as id, ov.value as value from optionables op 
 inner join option_values ov on ov.id = op.option_value_id where op.option_id = 4) as y on y.id = o.id 
 inner join (select op.optionable_id as id, ov.value as value from optionables op 
 inner join option_values ov on ov.id = op.option_value_id where op.option_id = 9) as z on z.id = o.id 
 inner join (select op.optionable_id as id, ov.value as value from optionables op 
 inner join option_values ov on ov.id = op.option_value_id where op.option_id = 10) as j on j.id = o.id
 inner join (select op.optionable_id as id, ov.value as value from optionables op 
 inner join option_values ov on ov.id = op.option_value_id where op.option_id = 1) as ss on ss.id = o.id 
 left join (select op.optionable_id as id, 
 if(op.option_value_id in (79,80,81,82,83,84,85, 86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,153),15,
 if(op.option_value_id in  (101,102,103,104,105,106,107,108,109),17, 
 if(op.option_value_id in (110), 18, if(op.option_value_id in (111,112,113,114,115,116,183), 19, 
 if(op.option_value_id = 200, 198,  if(op.option_value_id=199, 203, op.option_value_id-1)))))) as ovd 
 from optionables op inner join orders o on o.id = op.optionable_id 
 where op.option_id in (5,6,7,8,20,21,22,23,24,25,26,29,30) 
 and date(o.created_at) between '{START_DATE}' and '{END_DATE}' ) as 
 paper_type_group on paper_type_group.id = o.id 
 left join (select op.optionable_id as id, op.option_value_id as ovd from optionables op 
 inner join orders o on o.id = op.optionable_id where op.option_id in (2,18) 
 and date(o.created_at) between '{START_DATE}' and '{END_DATE}') as academic_level on academic_level.id = o.id 
 left join (select op.optionable_id as id, op.option_value_id as ovd from optionables op 
 inner join orders o on o.id = op.optionable_id where op.option_id in (1) 
 and date(o.created_at) between '{START_DATE}' and '{END_DATE}') as deadline on deadline.id = o.id 
 left join (select op.optionable_id as id, op.option_value_id as ovd from optionables op 
 inner join orders o on o.id = op.optionable_id where op.option_id in (4) 
 and date(o.created_at) between '{START_DATE}' and '{END_DATE}') as type_of_work on type_of_work.id = o.id  
 left join (select hj.id as id, if(hj.od in (45,46,48,29,39,52,57,50,61,62,64,67,90,91), 4, 
 if(hj.od in (71,72,86,42,17,47,11,12,15,21,35), 5, if(hj.od in (65,66,69,70,92,97), 25, 
 if(hj.od in (83,87), 32, if(hj.od in (73, 37), 5, if(hj.od in (76,88), 41, 
 if(hj.od in (74,84,85,89), 44, if(hj.od = 43, 49, if(hj.od in (68,75,79,80,81,82,98), 63, hj.od))))))))) 
 as sit from (( select o.id as id, oa.id as od from orders o inner join users u on u.id=o.user_id
 inner join oauth_clients oa on oa.id = u.app_id where date(o.created_at)
 between '{START_DATE}' and '{END_DATE}') hj )) as site on site.id = o.id where date(o.created_at)
 between '{START_DATE}' and '{END_DATE}' and op.optionable_type = 'Order' and op.deleted_at is null 
 and op.option_value_id = 119  and o.price > 0) vv  ) order by vv.id asc
